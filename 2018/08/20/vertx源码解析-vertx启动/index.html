<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="基于netty的轻量级框架">
    

    <!--Author-->
    
        <meta name="author" content="ZouFeng">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="vert.x源码解析-vertx启动"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="基于netty的轻量级框架" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="zoufeng_blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

    <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>vert.x源码解析-vertx启动 - zoufeng_blog</title>

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Google Analytics -->
    


</head>


<body>

<div class="bg-gradient"></div>
<div class="bg-pattern"></div>

<!-- Menu -->
<!--Menu Links and Overlay-->
<div class="menu-bg">
    <div class="menu-container">
        <ul>
            
            <li class="menu-item">
                <a href="/">
                    Home
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/archives">
                    Archives
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/about.html">
                    About
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/tags">
                    Tags
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/categories">
                    Categories
                </a>
            </li>
            
            <li class="menu-item">
                <a href="/contact.html">
                    Contact
                </a>
            </li>
            
        </ul>
    </div>
</div>

<!--Hamburger Icon-->
<nav>
    <a href="#menu"></a>
</nav>

<div class="container">

    <!-- Main Content -->
    <div class="row">
    <div class="col-sm-12">

        <!--Title and Logo-->
        <header>
    <div class="logo">
        <a href="/"><i class="logo-icon fa fa-cube" aria-hidden="true"></i></a>
        
    </div>
</header>

        <section class="main">
            
<div class="post">

    <div class="post-header">
        <h1 class="title">
            <a href="/2018/08/20/vertx源码解析-vertx启动/">
                vert.x源码解析-vertx启动
            </a>
        </h1>
        <div class="post-info">
            
                <span class="date">2018-08-20</span>
            
            
            
                <span class="category">
                    <a href="/categories/netty/">netty</a>
                </span>
            
        </div>
    </div>
	
	<div class="entry" style="position:fixed;left:10px" >
			<p class="show-toc-btn" id="show-toc-btn" onclick="showToc();" style="display:block">
				<span class="btn-bg"></span>
				<span class="btn-text">文章导航</span>
			</p>
		<div id="toc-article" class="toc-article" style="display:none">
			<span id="toc-close" class="toc-close" title="隐藏导航" onclick="showBtn();">x</span>
			<strong class="toc-title">文章目录</strong>
			<ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#vertx是什么"><span class="post-toc-number">1.</span> <span class="post-toc-text">vertx是什么</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#vertx的主要组件"><span class="post-toc-number">2.</span> <span class="post-toc-text">vertx的主要组件</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-verticle"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.verticle</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-context"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2.context</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-handler"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">3.handler</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-eventbus"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">4.eventbus</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#vertx示例demo"><span class="post-toc-number">3.</span> <span class="post-toc-text">vertx示例demo</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#一、vertx的实例化过程"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">一、vertx的实例化过程</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#二、vertx发布一个verticle"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">二、vertx发布一个verticle</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#总结"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">总结</span></a></li></ol></li></ol>
		</div>
		<script type="text/javascript">
			function showToc(){
				var toc_article = document.getElementById("toc-article");
				var show_toc_btn = document.getElementById("show-toc-btn");
				toc_article.setAttribute("style","display:block");
				show_toc_btn.setAttribute("style","display:none");
			};
			function showBtn(){
				var toc_article = document.getElementById("toc-article");
				var show_toc_btn = document.getElementById("show-toc-btn");
				toc_article.setAttribute("style","display:none");
				show_toc_btn.setAttribute("style","display:block");
			};
		</script>
	
    </div>
	
	
	<!-- 文章目录
	<div class="entry" style="position:fixed;right:10px" >
		<ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#vertx是什么"><span class="post-toc-number">1.</span> <span class="post-toc-text">vertx是什么</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#vertx的主要组件"><span class="post-toc-number">2.</span> <span class="post-toc-text">vertx的主要组件</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-verticle"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.verticle</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-context"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">2.context</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#3-handler"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">3.handler</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#4-eventbus"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">4.eventbus</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#vertx示例demo"><span class="post-toc-number">3.</span> <span class="post-toc-text">vertx示例demo</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#一、vertx的实例化过程"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">一、vertx的实例化过程</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#二、vertx发布一个verticle"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">二、vertx发布一个verticle</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#总结"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">总结</span></a></li></ol></li></ol>
    </div> -->

    <div class="content">

        <!-- Gallery -->
        

        <!-- Post Content -->
        <p>去年在做智能网关前调研了gravitee这个高性能网关,而gravitee是基于vertx开发的，于是顺带看了下vertx，当时简单做了下笔记，这里和大家分享一下。</p>
<h1 id="vertx是什么"><a href="#vertx是什么" class="headerlink" title="vertx是什么"></a>vertx是什么</h1><p><a href="https://vertx.io/" target="_blank" rel="noopener">vertx</a>是基于jvm构建的应用平台。</p>
<p>vertx复用netty的EvenLoopGroup实现的reactor模型（所以了解netty的话看vertx源码还是比较轻松的），采用异步无锁编程，是一个轻量级高性能的异步框架。vertx之间采用了Actor模型，有极好的分布式开发支持。</p>
<p>Vertx是面向io的，有丰富的io支持。已支持TCP、UDP、FileSystem、DNS、EventBus、Sockjs等，基本满足绝大多数系统架构需求</p>
<h1 id="vertx的主要组件"><a href="#vertx的主要组件" class="headerlink" title="vertx的主要组件"></a>vertx的主要组件</h1><h2 id="1-verticle"><a href="#1-verticle" class="headerlink" title="1.verticle"></a>1.verticle</h2><p>vertx的概念很少，主要的组件就是verticle。官方文档里把vertx定义为一个异步平台，类比于在jvm上的操作系统，verticle就是在上面运行的软件。我们开发人员也只需要关注写verticle。你也可以把Verticle想成Actor Model中的Actor。</p>
<p><img src="/img/middleware/netty/vertx/verticle.png" alt="verticle" title="verticle"></p>
<p>verticle的接口也是很简单，只有4个方法，除了getVertx其他都是它的生命周期方法。</p>
<p>verticle有三种类型，标准的verticle，单线程 Work Verticle和多线程的work Verticle。<br>vertx定位自己是个高性能框架，非常厌恶阻塞，所以标准的verticle是使用eventloop执行的，执行的是一些不会阻塞的代码和任务。会阻塞线程的任务使用work Verticle来执行，work verticle不使用eventloop而是自定义的work threadpool。</p>
<h2 id="2-context"><a href="#2-context" class="headerlink" title="2.context"></a>2.context</h2><p>当Vert.x调用Verticle时与Context相关联，通常来说这个 Context 会是一个 EventLoop Context，它绑定到了一个特定的EventLoop线程上。所以在该Context上执行的操作总是在同一个EventLoop线程中。类似于netty的ChannelContext，不过Vertx的Context是与线程（netty的eventLoop）绑定，ChannelContext是和Channel绑定，有一丢丢的区别。</p>
<h2 id="3-handler"><a href="#3-handler" class="headerlink" title="3.handler"></a>3.handler</h2><p>vertx是基于事件的响应式框架，handler就是基于事件的异步回调组件</p>
<h2 id="4-eventbus"><a href="#4-eventbus" class="headerlink" title="4.eventbus"></a>4.eventbus</h2><p>EventBus是Vertx的神经系统，vertx可以通过他进行内部或外部进行通信。而且EventBus可形成跨越多个服务器节点和多个浏览器的点对点的分布式消息系统。EventBus支持发布/订阅、点对点、请求/响应的消息通信方式。<br>这里eventbus也对应Actor Model中的信箱。</p>
<p>以下是vertx简单的运行模型</p>
<p><img src="/img/middleware/netty/vertx/vertx_0.jpg" alt="verticle" title="vertx概览"></p>
<p>熟悉netty的线程模型的同学看到这张图应该会有点眼熟，verticle和channel是极其相似的</p>
<h1 id="vertx示例demo"><a href="#vertx示例demo" class="headerlink" title="vertx示例demo"></a>vertx示例demo</h1><p>简单写个vertxdemo,这个demo是一个简单的代理服务器，将/hello直接代理到qq的首页。作为我们分析源码的入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zoufeng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2018/8/18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldServerVerticle</span> <span class="keyword">extends</span> <span class="title">AbstractVerticle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        request();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Vertx vertx = Vertx.vertx();</span><br><span class="line">        vertx.deployVerticle(HelloWorldServerVerticle.class.getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        vertx.createHttpServer(<span class="keyword">new</span> HttpServerOptions()).requestHandler(httpServerRequest -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (httpServerRequest.uri().equals(<span class="string">"/hello"</span>) &amp;&amp; httpServerRequest.method().equals(HttpMethod.GET)) &#123;</span><br><span class="line">                HttpServerResponse httpServerResponse = httpServerRequest.response().setChunked(<span class="keyword">true</span>);</span><br><span class="line">                vertx.createHttpClient(<span class="keyword">new</span> HttpClientOptions()</span><br><span class="line">                        .setKeepAlive(<span class="keyword">false</span>))</span><br><span class="line">                        .request(httpServerRequest.method(), <span class="number">80</span>, <span class="string">"www.qq.com"</span>, <span class="string">"/"</span>)</span><br><span class="line">                        .handler(response -&gt; &#123;</span><br><span class="line">                            System.out.println(<span class="string">"Received response with status code "</span> + response.statusCode());</span><br><span class="line"></span><br><span class="line">                            <span class="comment">//copy header</span></span><br><span class="line">                            response.headers().forEach(entry -&gt; &#123;</span><br><span class="line">                                httpServerResponse.putHeader(entry.getKey(), entry.getValue());</span><br><span class="line">                            &#125;);</span><br><span class="line">                            <span class="comment">//copy body writeStream</span></span><br><span class="line">                            Pump.pump(response, httpServerResponse).start();</span><br><span class="line">                        &#125;).end();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                httpServerRequest.response().setStatusCode(<span class="number">404</span>).end(<span class="string">"not found"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).listen(<span class="number">8089</span>, result -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (result.succeeded()) &#123;</span><br><span class="line">                System.out.println(<span class="string">"listen 8089 success !!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到main函数里vertx的服务启动代码非常简单，只需要两行代码：初始化一个vertx对象，然后vertx发布一个Verticle实例。整个服务就启动了。<br>那里面到底发生了什么呢，</p>
<h2 id="一、vertx的实例化过程"><a href="#一、vertx的实例化过程" class="headerlink" title="一、vertx的实例化过程"></a>一、vertx的实例化过程</h2><ul>
<li>1.vertx首先获取VertxFactory，获取方式有spi或编程的方式，默认是VertxFactoryImpl直接new VertxImpl();</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VertxFactoryImpl</span> <span class="keyword">implements</span> <span class="title">VertxFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Vertx <span class="title">vertx</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> VertxImpl();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>2.根据VertxOptions配置Vertx,比如EventLoopPoolSize,workPoolSize,eventBusOptions（eventbus是vertx进程间通信的一个组件）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VertxImpl(VertxOptions options) &#123;</span><br><span class="line">  <span class="keyword">this</span>(options, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>3.看看有没有初始化Context（默认是木有的，有就报错- -）,Transport设置啥类型，默认JDK。</li>
<li>4.启动一个checker去检测线程阻塞情况（本质是个守护线程的timer）,检测的方式很简单粗暴，内部维护一个VerxThred线程的集合，当前时间比对线程开始的执行时间，超时了就日志警告。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">BlockedThreadChecker(<span class="keyword">long</span> interval, <span class="keyword">long</span> warningExceptionTime) &#123;</span><br><span class="line">    timer = <span class="keyword">new</span> Timer(<span class="string">"vertx-blocked-thread-checker"</span>, <span class="keyword">true</span>);</span><br><span class="line">    timer.schedule(<span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (BlockedThreadChecker.<span class="keyword">this</span>) &#123;</span><br><span class="line">          <span class="keyword">long</span> now = System.nanoTime();</span><br><span class="line">          <span class="keyword">for</span> (VertxThread thread : threads.keySet()) &#123;</span><br><span class="line">            <span class="keyword">long</span> execStart = thread.startTime();</span><br><span class="line">            <span class="keyword">long</span> dur = now - execStart;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> timeLimit = thread.getMaxExecTime();</span><br><span class="line">            <span class="keyword">if</span> (execStart != <span class="number">0</span> &amp;&amp; dur &gt; timeLimit) &#123;</span><br><span class="line">              <span class="keyword">final</span> String message = <span class="string">"Thread "</span> + thread + <span class="string">" has been blocked for "</span> + (dur / <span class="number">1000000</span>) + <span class="string">" ms, time limit is "</span> + (timeLimit / <span class="number">1000000</span>);</span><br><span class="line">              <span class="keyword">if</span> (dur &lt;= warningExceptionTime) &#123;</span><br><span class="line">                log.warn(message);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                VertxException stackTrace = <span class="keyword">new</span> VertxException(<span class="string">"Thread blocked"</span>);</span><br><span class="line">                stackTrace.setStackTrace(thread.getStackTrace());</span><br><span class="line">                log.warn(message, stackTrace);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, interval, interval);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>5.设置eventLoopGroup，这里Vertx是拿来主义，直接用netty的NioEventLoopGroup，并设置NioEventLoopGroup处理io任务的比率，线程数默认为两倍cpu核数。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> EventLoopGroup <span class="title">eventLoopGroup</span><span class="params">(<span class="keyword">int</span> nThreads, ThreadFactory threadFactory, <span class="keyword">int</span> ioRatio)</span> </span>&#123;</span><br><span class="line">   NioEventLoopGroup eventLoopGroup = <span class="keyword">new</span> NioEventLoopGroup(nThreads, threadFactory);</span><br><span class="line">   eventLoopGroup.setIoRatio(ioRatio);</span><br><span class="line">   <span class="keyword">return</span> eventLoopGroup;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>6.设置acceptorEventLoopGroup，默认是一个线程并且设置处理io事件的比例是100%，按照源码说法在大量的请求下，如果事件循环的接受线程和上面的循环器线程在一个线程池里容易延迟。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The acceptor event loop thread needs to be from a different pool otherwise can get lags in accepted connections</span></span><br><span class="line">  <span class="comment">// under a lot of load</span></span><br><span class="line">  acceptorEventLoopGroup = transport.eventLoopGroup(<span class="number">1</span>, acceptorEventLoopThreadFactory, <span class="number">100</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>7.设置VertxMetrices,这里也是以SPI的方式加载，用来记录vertx内部执行的打点信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">metrics = initialiseMetrics(options);</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> VertxMetrics <span class="title">initialiseMetrics</span><span class="params">(VertxOptions options)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (options.getMetricsOptions() != <span class="keyword">null</span> &amp;&amp; options.getMetricsOptions().isEnabled()) &#123;</span><br><span class="line">      VertxMetricsFactory factory = options.getMetricsOptions().getFactory();</span><br><span class="line">      <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">        factory = ServiceHelper.loadFactoryOrNull(VertxMetricsFactory.class);</span><br><span class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">          log.warn(<span class="string">"Metrics has been set to enabled but no VertxMetricsFactory found on classpath"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (factory != <span class="keyword">null</span>) &#123;</span><br><span class="line">        VertxMetrics metrics = factory.metrics(<span class="keyword">this</span>, options);</span><br><span class="line">        Objects.requireNonNull(metrics, <span class="string">"The metric instance created from "</span> + factory + <span class="string">" cannot be null"</span>);</span><br><span class="line">        <span class="keyword">return</span> metrics;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>8.默认初始化20线程的工作线程池workerExec（执行业务流程或者阻塞任务的线程池），20线程的internalBlockingExec（执行vertx内部阻塞任务的线程池），DeploymentManager（【重要的类】管理所有的VertxFactories,用来部署Verticles）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * The default number of event loop threads to be used  = 2 * number of cores on the machine</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_EVENT_LOOP_POOL_SIZE = <span class="number">2</span> * CpuCoreSensor.availableProcessors();</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * The default number of threads in the worker pool = 20</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_WORKER_POOL_SIZE = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * The default number of threads in the internal blocking  pool (used by some internal operations) = 20</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INTERNAL_BLOCKING_POOL_SIZE = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">ExecutorService workerExec = Executors.newFixedThreadPool(options.getWorkerPoolSize(),</span><br><span class="line">       <span class="keyword">new</span> VertxThreadFactory(<span class="string">"vert.x-worker-thread-"</span>, checker, <span class="keyword">true</span>, options.getMaxWorkerExecuteTime()));</span><br><span class="line">   PoolMetrics workerPoolMetrics = metrics != <span class="keyword">null</span> ? metrics.createMetrics(workerExec, <span class="string">"worker"</span>, <span class="string">"vert.x-worker-thread"</span>, options.getWorkerPoolSize()) : <span class="keyword">null</span>;</span><br><span class="line">   ExecutorService internalBlockingExec = Executors.newFixedThreadPool(options.getInternalBlockingPoolSize(),</span><br><span class="line">       <span class="keyword">new</span> VertxThreadFactory(<span class="string">"vert.x-internal-blocking-"</span>, checker, <span class="keyword">true</span>, options.getMaxWorkerExecuteTime()));</span><br><span class="line">   PoolMetrics internalBlockingPoolMetrics = metrics != <span class="keyword">null</span> ? metrics.createMetrics(internalBlockingExec, <span class="string">"worker"</span>, <span class="string">"vert.x-internal-blocking"</span>, options.getInternalBlockingPoolSize()) : <span class="keyword">null</span>;</span><br><span class="line">   internalBlockingPool = <span class="keyword">new</span> WorkerPool(internalBlockingExec, internalBlockingPoolMetrics);</span><br></pre></td></tr></table></figure>
</li>
<li><p>9.创建并开始EventBus,默认是 new EventBusImpl(),用来和其他vertx实例或verticle之间通信，看传递消息源码可以大概知道EventBus通信是通过异步rpc的方式，保持一贯厌恶阻塞的原则。底层是通过他的service proxy组件提供的代理类实现，发送消息异步方法提供一个回调函数 Handler&lt;AsyncResult<t>&gt;，在调用结果发送过来的时候会自动调用绑定的回调函数进行相关的处理。</t></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span> (VertxImpl.<span class="keyword">this</span>) &#123;</span><br><span class="line">            haManager = <span class="keyword">new</span> HAManager(<span class="keyword">this</span>, deploymentManager, clusterManager, options.getQuorumSize(),</span><br><span class="line">                                      options.getHAGroup(), haEnabled);</span><br><span class="line">            createAndStartEventBus(options, resultHandler);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//eventBus 发送消息，先判断是否是发送本地消息，然后执行deliverToHandler方法</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">sendOrPub</span><span class="params">(SendContextImpl&lt;T&gt; sendContext)</span> </span>&#123;</span><br><span class="line">    MessageImpl message = sendContext.message;</span><br><span class="line">    <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">      metrics.messageSent(message.address(), !message.isSend(), <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    deliverMessageLocally(sendContext);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">deliverMessageLocally</span><span class="params">(MessageImpl msg)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//..省略些源码</span></span><br><span class="line">        <span class="keyword">for</span> (HandlerHolder holder: handlers.list) &#123;</span><br><span class="line">          deliverToHandler(msg, holder);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">        metrics.messageReceived(msg.address(), !msg.isSend(), isMessageLocal(msg), <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">deliverToHandler</span><span class="params">(MessageImpl msg, HandlerHolder&lt;T&gt; holder)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Each handler gets a fresh copy</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    Message&lt;T&gt; copied = msg.copyBeforeReceive();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">      metrics.scheduleMessage(holder.getHandler().getMetric(), msg.isLocal());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    holder.getContext().runOnContext((v) -&gt; &#123;</span><br><span class="line">      <span class="comment">// Need to check handler is still there - the handler might have been removed after the message were sent but</span></span><br><span class="line">      <span class="comment">// before it was received</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!holder.isRemoved()) &#123;</span><br><span class="line">          holder.getHandler().handle(copied);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (holder.isReplyHandler()) &#123;</span><br><span class="line">          holder.getHandler().unregister();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>10.初始化ShardDataImpl,这个是vertx用来共享数据的管理类，内部本质是一个ConcurrentHashMap，不仅可以跨线程共享，还能跨进程在不同的vertx集群之间共享数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">this</span>.sharedData = <span class="keyword">new</span> SharedDataImpl(<span class="keyword">this</span>, clusterManager);</span><br><span class="line"></span><br><span class="line"><span class="comment">//SharedDataImpl内部变量</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> VertxInternal vertx;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ClusterManager clusterManager;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> LocalAsyncLocks localAsyncLocks;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, LocalAsyncMapImpl&lt;?, ?&gt;&gt; localAsyncMaps = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Counter&gt; localCounters = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"><span class="comment">//本地实例共享数据</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, LocalMap&lt;?, ?&gt;&gt; localMaps = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//集群间共享数据</span></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> &lt;K, V&gt; <span class="function"><span class="keyword">void</span> <span class="title">getClusterWideMap</span><span class="params">(String name, Handler&lt;AsyncResult&lt;AsyncMap&lt;K, V&gt;&gt;&gt; resultHandler)</span> </span>&#123;</span><br><span class="line">    Objects.requireNonNull(name, <span class="string">"name"</span>);</span><br><span class="line">    Objects.requireNonNull(resultHandler, <span class="string">"resultHandler"</span>);</span><br><span class="line">    <span class="keyword">if</span> (clusterManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Can't get cluster wide map if not clustered"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    clusterManager.&lt;K, V&gt;getAsyncMap(name, ar -&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (ar.succeeded()) &#123;</span><br><span class="line">        <span class="comment">// Wrap it</span></span><br><span class="line">        resultHandler.handle(Future.succeededFuture(<span class="keyword">new</span> WrappedAsyncMap&lt;K, V&gt;(ar.result())));</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        resultHandler.handle(Future.failedFuture(ar.cause()));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>现在Vertx初始化就干了这些，看起来好像啥的都没做，都是为后面发布Verticle准备。</p>
<h2 id="二、vertx发布一个verticle"><a href="#二、vertx发布一个verticle" class="headerlink" title="二、vertx发布一个verticle"></a>二、vertx发布一个verticle</h2><p>从deployVerticle(String name)入口进入，可以看到发布Verticle这东西全部都是DeploymentManager操刀。</p>
<ul>
<li>1.获取发布的Context,UUID给它随机生成一个DeployId.前面说过了，Context是与eventLoop线程绑定的，默认情况下当前线程是没有Context的，没有的话就去生成一个EventLoopContext,这个Context还承载了workPool,orderTaskQueue,这里的workpool就是我们自定义用来执行阻塞任务的线程池，orderTaskQueue是方便我们设置任务的执行优先级。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deployVerticle</span><span class="params">(String identifier,</span></span></span><br><span class="line"><span class="function"><span class="params">                             DeploymentOptions options,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Handler&lt;AsyncResult&lt;String&gt;&gt; completionHandler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (options.isMultiThreaded() &amp;&amp; !options.isWorker()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"If multi-threaded then must be worker too"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ContextImpl callingContext = vertx.getOrCreateContext();</span><br><span class="line">    ClassLoader cl = getClassLoader(options, callingContext);</span><br><span class="line">    doDeployVerticle(identifier, generateDeploymentID(), options, callingContext, callingContext, cl, completionHandler);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>2.接着DeploymentManager做了些兼容相关的东西，根据我们传的verticle名字去判断VerticleFactory是那种类型的，加载Verticle是需不需要额外的操作啥的</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (iter.hasNext()) &#123;</span><br><span class="line">      VerticleFactory verticleFactory = iter.next();</span><br><span class="line">      Future&lt;String&gt; fut = Future.future();</span><br><span class="line">      <span class="keyword">if</span> (verticleFactory.requiresResolve()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          verticleFactory.resolve(identifier, options, cl, fut);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            fut.fail(e);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line">            <span class="comment">// Too late</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fut.complete(identifier);</span><br><span class="line">      &#125;</span><br><span class="line">      fut.setHandler(ar -&gt; &#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>看到这里的代码其实就大概知道vertx的handler是怎么执行的。Vertx的Future在设置handler的时会先判断这个futrue有没有完成，完成了就执行handler，没有完成就继续窝着，在事件完成时再进行回调（Vert.x 中的 Future 即异步开发模式中的 Future/Promise 模式的实现）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;T&gt; <span class="title">setHandler</span><span class="params">(Handler&lt;AsyncResult&lt;T&gt;&gt; handler)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">boolean</span> callHandler;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">     callHandler = isComplete();</span><br><span class="line">     <span class="keyword">if</span> (!callHandler) &#123;</span><br><span class="line">       <span class="keyword">this</span>.handler = handler;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (callHandler) &#123;</span><br><span class="line">     handler.handle(<span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>3.接着就按配置反射生成这个Verticle的实例，默认情况下用当前线程类加载器来加载类，而不会创建一个新的。如果我们需要对我们的程序进行隔离话可以自定义一个类加载器，类似于tomcat加载不同的war包，做到程序隔离。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//反射生成实例</span></span><br><span class="line">Verticle[] verticles = createVerticles(verticleFactory, identifier, options.getInstances(), cl);</span><br><span class="line">                doDeploy(identifier, deploymentID, options, parentContext, callingContext, completionHandler, cl, verticles);</span><br></pre></td></tr></table></figure>
<ul>
<li>4.继续跟进doDeploy方法，这里就是给verticle创建执行的context,然后启动verticle,runOnContext()。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">JsonObject conf = options.getConfig() == <span class="keyword">null</span> ? <span class="keyword">new</span> JsonObject() : options.getConfig().copy(); <span class="comment">// Copy it</span></span><br><span class="line">    String poolName = options.getWorkerPoolName();</span><br><span class="line"></span><br><span class="line">    Deployment parent = parentContext.getDeployment();</span><br><span class="line">    DeploymentImpl deployment = <span class="keyword">new</span> DeploymentImpl(parent, deploymentID, identifier, options);</span><br><span class="line"></span><br><span class="line">    AtomicInteger deployCount = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">    AtomicBoolean failureReported = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line">    <span class="keyword">for</span> (Verticle verticle: verticles) &#123;</span><br><span class="line">      WorkerExecutorImpl workerExec = poolName != <span class="keyword">null</span> ? vertx.createSharedWorkerExecutor(poolName, options.getWorkerPoolSize(), options.getMaxWorkerExecuteTime()) : <span class="keyword">null</span>;</span><br><span class="line">      WorkerPool pool = workerExec != <span class="keyword">null</span> ? workerExec.getPool() : <span class="keyword">null</span>;</span><br><span class="line">      ContextImpl context = options.isWorker() ? vertx.createWorkerContext(options.isMultiThreaded(), deploymentID, pool, conf, tccl) :</span><br><span class="line">        vertx.createEventLoopContext(deploymentID, pool, conf, tccl);</span><br><span class="line"><span class="comment">//这里为每个Verticle又创建一个Context，绑定一个EventLoop,后面这个Verticle的生命周期就和这个Context绑定了</span></span><br><span class="line">      <span class="keyword">if</span> (workerExec != <span class="keyword">null</span>) &#123;</span><br><span class="line">        context.addCloseHook(workerExec);</span><br><span class="line">      &#125;</span><br><span class="line">      context.setDeployment(deployment);</span><br><span class="line">      deployment.addVerticle(<span class="keyword">new</span> VerticleHolder(verticle, context));<span class="comment">//verticleHolder记录Verticle和Context绑定关系</span></span><br><span class="line">      context.runOnContext(v -&gt; &#123;<span class="comment">//verticle在Context上运行</span></span><br><span class="line">        <span class="comment">//略</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>5.执行runOnContext是异步的，其实这里就到了事件循环器的核心了,也就是netty那块的代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runOnContext</span><span class="params">(Handler&lt;Void&gt; task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      executeAsync(task);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException ignore) &#123;</span><br><span class="line">      <span class="comment">// Pool is already shut down</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executeAsync</span><span class="params">(Handler&lt;Void&gt; task)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// No metrics, we are on the event loop.</span></span><br><span class="line">    nettyEventLoop().execute(wrapTask(<span class="keyword">null</span>, task, <span class="keyword">true</span>, <span class="keyword">null</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Runnable <span class="title">wrapTask</span><span class="params">(ContextTask cTask, Handler&lt;Void&gt; hTask, <span class="keyword">boolean</span> checkThread, PoolMetrics metrics)</span> </span>&#123;</span><br><span class="line">...略</span><br><span class="line"><span class="comment">//将context与当前线程绑定</span></span><br><span class="line"> setContext(current, ContextImpl.<span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (cTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">          cTask.run();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          hTask.handle(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>6.这里有个细节，wrapTask执行任务的线程绑定了当前的context。这样保证了在一个context上执行任务的都是同一个eventloop。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"task"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> inEventLoop = <span class="keyword">this</span>.inEventLoop();</span><br><span class="line">            <span class="keyword">if</span> (inEventLoop) &#123;</span><br><span class="line">                <span class="keyword">this</span>.addTask(task);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.startThread();<span class="comment">//当前线程要是不是这个eventLoop记录的线程就初始化线程</span></span><br><span class="line">                <span class="keyword">this</span>.addTask(task);<span class="comment">//任务加入队列，让该eventLoop的线程轮询处理</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.isShutdown() &amp;&amp; <span class="keyword">this</span>.removeTask(task)) &#123;</span><br><span class="line">                    reject();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.addTaskWakesUp &amp;&amp; <span class="keyword">this</span>.wakesUpForTask(task)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.wakeup(inEventLoop);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>7.看看startThread如何工作，先将当前线程设置为eventLoop的线程，然后开始调用NioEventLoop的run方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doStartThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">assert</span> thread == <span class="keyword">null</span>;</span><br><span class="line">        executor.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                thread = Thread.currentThread();</span><br><span class="line">                <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">                    thread.interrupt();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">                updateLastExecutionTime();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    SingleThreadEventExecutor.<span class="keyword">this</span>.run();<span class="comment">//这里是调用了NioEventLoop的run方法</span></span><br><span class="line">                    success = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    logger.warn(<span class="string">"Unexpected exception from an event executor: "</span>, t);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                  <span class="comment">//略略略</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>8.NioEventLoop不停轮询Selector的事件（这里我们没有暂时没有起Bootstrap去监听socket，没有这些事件）,执行taskQueue里的任务。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">switch</span> (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) &#123;</span><br><span class="line">                    <span class="keyword">case</span> SelectStrategy.CONTINUE:</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">case</span> SelectStrategy.SELECT:</span><br><span class="line">                        select(wakenUp.getAndSet(<span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                &#125;</span><br><span class="line">                cancelledKeys = <span class="number">0</span>;</span><br><span class="line">                needsToSelectAgain = <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> ioRatio = <span class="keyword">this</span>.ioRatio;</span><br><span class="line">                <span class="keyword">if</span> (ioRatio == <span class="number">100</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        processSelectedKeys();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="comment">// Ensure we always run tasks.</span></span><br><span class="line">                        runAllTasks();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> ioStartTime = System.nanoTime();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        processSelectedKeys();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="comment">// Ensure we always run tasks.</span></span><br><span class="line">                        <span class="keyword">final</span> <span class="keyword">long</span> ioTime = System.nanoTime() - ioStartTime;</span><br><span class="line">                        runAllTasks(ioTime * (<span class="number">100</span> - ioRatio) / ioRatio);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                handleLoopException(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Always handle shutdown even if the loop processing threw an exception.</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (isShuttingDown()) &#123;</span><br><span class="line">                    closeAll();</span><br><span class="line">                    <span class="keyword">if</span> (confirmShutdown()) &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                handleLoopException(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>9.从netty回到我们的Vertx，runOnContext（）,在这里可以看到我们熟悉的Verticle的init，start的方法了,到这里vertx启动verticle的流程就结束了。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">context.runOnContext(v -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          verticle.init(vertx, context);</span><br><span class="line">          Future&lt;Void&gt; startFuture = Future.future();</span><br><span class="line">          verticle.start(startFuture);</span><br><span class="line">          startFuture.setHandler(ar -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (ar.succeeded()) &#123;</span><br><span class="line">              <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (parent.addChild(deployment)) &#123;</span><br><span class="line">                  deployment.child = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// Orphan</span></span><br><span class="line">                  deployment.undeploy(<span class="keyword">null</span>);</span><br><span class="line">                  <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              VertxMetrics metrics = vertx.metricsSPI();</span><br><span class="line">              <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">                metrics.verticleDeployed(verticle);</span><br><span class="line">              &#125;</span><br><span class="line">              deployments.put(deploymentID, deployment);</span><br><span class="line">              <span class="keyword">if</span> (deployCount.incrementAndGet() == verticles.length) &#123;</span><br><span class="line">                reportSuccess(deploymentID, callingContext, completionHandler);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (failureReported.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">              deployment.rollback(callingContext, completionHandler, context, ar.cause());</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">          <span class="keyword">if</span> (failureReported.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>))</span><br><span class="line">            deployment.rollback(callingContext, completionHandler, context, t);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以上就是vertx的启动发布流程，其实还是比较简洁的,毕竟算是netty的封装，事件循环都被netty做掉了。<br>简单回顾下启动发布流程：</p>
<ul>
<li>1.生成vertx对象，设置eventLoop的线程数，enventbus的配置</li>
<li>2.生成verticle实例，为verticle生成context，并把context绑定eventLoop</li>
<li>3.在verticle的context上执行verticle的生命周期，init，start方法</li>
</ul>
<p>整个流程的核心思想是事件驱动，尽量减少线程数和线程切换，减少阻塞的任务，阻塞任务不占用eventLoop的线程池，使用专门的阻塞线程池异步执行。</p>

    </div>

    

    
        <div class="post-tags">
            <i class="fa fa-tags" aria-hidden="true"></i>
            <a href="/tags/笔记/">#笔记</a> <a href="/tags/netty/">#netty</a> <a href="/tags/vertx/">#vertx</a>
        </div>
    

    <!-- Comments -->
    

</div>
        </section>

    </div>
</div>


</div>

<!-- Footer -->
<div class="push"></div>

<footer class="footer-content">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 footer-about">
                <h2>About</h2>
                <p>
                    This theme was developed by <a href="https://github.com/klugjo">Jonathan Klughertz</a>. The source code is available on Github. Create Websites. Make Magic.
                </p>
            </div>
            
    <div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 recent-posts">
        <h2>Recent Posts</h2>
        <ul>
            
            <li>
                <a class="footer-post" href="/2018/12/19/rxjava碎碎念/">rxjava设计原理</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2018/09/17/rxjava设计原理/">rxjava设计原理</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2018/09/09/vertx-circuitBreadker源码解析/">vertx-circuitBreadker源码解析</a>
            </li>
            
            <li>
                <a class="footer-post" href="/2018/08/27/vertx-httpserver源码解析/">vertx httpserver源码解析</a>
            </li>
            
        </ul>
    </div>



            
<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3 footer-categories">
    <h2>Categories</h2>
    <ul>
        
        <li>
            <a class="footer-post" href="/categories/emotion/">emotion</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/j-u-c/">j.u.c</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/jdk/">jdk</a>
        </li>
        
        <li>
            <a class="footer-post" href="/categories/netty/">netty</a>
        </li>
        
    </ul>
</div>

        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <ul class="list-inline footer-social-icons">
                    
                    <li class="list-inline-item">
                        <a href="https://github.com/klugjo/hexo-theme-alpha-dust">
                            <span class="footer-icon-container">
                                <i class="fa fa-github"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://twitter.com/?lang=en">
                            <span class="footer-icon-container">
                                <i class="fa fa-twitter"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.facebook.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-facebook"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.instagram.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-instagram"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://dribbble.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-dribbble"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://plus.google.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-google-plus"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://www.behance.net/">
                            <span class="footer-icon-container">
                                <i class="fa fa-behance"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="https://500px.com/">
                            <span class="footer-icon-container">
                                <i class="fa fa-500px"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="mailto:test@example.com">
                            <span class="footer-icon-container">
                                <i class="fa fa-envelope-o"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li class="list-inline-item">
                        <a href="\#">
                            <span class="footer-icon-container">
                                <i class="fa fa-rss"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <div class="footer-copyright">
                    @Untitled. All right reserved | Design & Hexo <a href="http://www.codeblocq.com/">Jonathan Klughertz</a>
                </div>
            </div>
        </div>
    </div>
</footer>

<!-- After footer scripts -->

<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Tween Max -->
<script src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.5/TweenMax.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Custom JavaScript -->
<script src="/js/main.js"></script>

<!-- Disqus Comments -->



</body>

</html>